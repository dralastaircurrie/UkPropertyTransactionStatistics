---
title: 'UK property transactions counts -- July 2017 '
author: "KAI Data Exploitation cover version"
output:
  html_document:
    keep_md: TRUE
  github_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(readxl)
library(kableExtra)
library(lubridate)
library(tidyverse)
library(knitr)
library(xts)
library(dygraphs)
```
# Plots
```{r plots}
resCountRaw <- read_xlsx('./UK_Tables_Aug_2017_monthlies.xlsx','Residential')
nonresCountRaw <- read_xlsx('./UK_Tables_Aug_2017_monthlies.xlsx','Non-residential')

resCount <- resCountRaw %>%
            gather('area','count',2:7) %>%
            mutate(category='residential')
            
nonresCount <- nonresCountRaw %>%
               gather('area','count',2:7) %>% 
               mutate(category='non-residential')

monthlyCount <- dplyr::union(resCount,nonresCount) %>%
                mutate(
                  sa=(area=='UKSeasonallyAdjusted'),
                  year=strftime(month,format='%Y'),
                  fyst=year(month)-as.integer( month(month)<4 ),
                  fy=paste0(as.character(fyst),'\U2013',as.character((fyst+1) %% 100)),
                  quarter=quarters(month),
                  area=replace(area,area=='UKSeasonallyAdjusted','UK')
                )

thisMonth <- ymd('2017-07-01',tz='UTC')
recentRangeStart <- thisMonth %m+% months(-17)
historicRangeStart <- ymd('2005-04-01',tz='UTC')
recentMonths <- seq(recentRangeStart,thisMonth,by='month')
historicMonths <- seq(historicRangeStart,thisMonth,by='month')
```

```{r chart1a}
monthlyCount %>% 
  filter(area == 'UK') %>%
  filter(month %in% recentMonths) %>%
  filter(category == 'residential') -> data1a
data1a %>% filter(sa==FALSE) -> data1a_raw
data1a %>% filter(sa==TRUE) -> data1a_adj
uk_raw <- xts(data1a_raw$count,data1a_raw$month)
uk_adj <- xts(data1a_adj$count,data1a_adj$month)
ts1a <- cbind(uk_raw,uk_adj)
colnames(ts1a) <- c('Unadjusted','Seasonally adjusted')
dygraph(ts1a) %>%
  dyLegend(show='always',width = 500) %>%
  dyOptions(includeZero = TRUE) %>%
  dyAxis('x', drawGrid = FALSE) %>%
  dyAxis('y',drawGrid = FALSE, label = 'Transactions')
  
```

```{r}
monthlyCount %>% 
  filter(area == 'UK') %>%
  filter(month %in% recentMonths) %>%
  filter(category == 'non-residential') %>%
  ggplot(mapping = aes(x=month,y=count,colour=sa)) +
  expand_limits(y=0) +
  geom_line() -> chart1b
plot(chart1b)

monthlyCount %>% 
  filter(area == 'UK') %>%
  filter(month %in% historicMonths) %>%
  filter(category == 'residential') %>%
  ggplot(mapping = aes(x=month,y=count,colour=sa)) +
  expand_limits(y=0) +
  geom_line() -> chart4a
plot(chart4a)

monthlyCount %>% 
  filter(area == 'UK') %>%
  filter(month %in% historicMonths) %>%
  filter(category == 'non-residential') %>%
  ggplot(mapping = aes(x=month,y=count,colour=sa)) +
  expand_limits(y=0) +
  geom_line() -> chart4b
plot(chart4b)

monthlyCount %>% 
  filter(area == 'England') %>%
  filter(month %in% historicMonths) %>%
  ggplot(mapping = aes(x=month,y=count,colour=category)) +
  facet_grid(category ~ ., scales="free_y" )+
  expand_limits(y=0) +
  geom_line() -> chart4c
plot(chart4c) # TODO dual y-axes, see http://lehoangvan.com/posts/dual-y-axis-ggplot2/

monthlyCount %>% 
  filter(area == 'Scotland') %>%
  filter(month %in% historicMonths) %>%
  ggplot(mapping = aes(x=month,y=count,colour=category)) +
  facet_grid(category ~ ., scales="free_y" )+
  expand_limits(y=0) +
  geom_line() -> chart4d
plot(chart4d)

monthlyCount %>% 
  filter(area == 'Wales') %>%
  filter(month %in% historicMonths) %>%
  ggplot(mapping = aes(x=month,y=count,colour=category)) +
  facet_grid(category ~ ., scales="free_y" )+
  expand_limits(y=0) +
  geom_line() -> chart4e
plot(chart4e) # TODO dual y-axes, see http://lehoangvan.com/posts/dual-y-axis-ggplot2/

monthlyCount %>% 
  filter(area == 'Northern Ireland') %>%
  filter(month %in% historicMonths) %>%
  ggplot(mapping = aes(x=month,y=count,colour=category)) +
  facet_grid(category ~ ., scales="free_y" )+
  expand_limits(y=0) +
  geom_line() -> chart4f
plot(chart4f)
```

#Reproducing the tables
 Table 2
 
```{r tabulate}
monthlyCount %>% filter(month %in% recentMonths, category == 'residential') %>% select (-c(category,year,fyst,fy,quarter)) %>% spread(area,count) %>% kable
 ```